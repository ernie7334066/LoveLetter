<!DOCTYPE html>
<html>
  <head>
    <title>Redux basic example</title>
    <script src="https://unpkg.com/redux@latest/dist/redux.min.js"></script>
    <script
    src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
  </head>
  <body>
    <div>
      <p>
        Clicked: <span id="value">0</span> times
        <button id="increment">+</button>
        <button id="decrement">-</button>
        <button id="incrementIfOdd">Increment if odd</button>
        <button id="incrementAsync">Increment async</button>
        <button id="incrementby2">Increment by 2</button>
        Current Player ID: <span id="currentPlayerId"></span>

        <button class="ui button" id="playButton1">A</button>
        <button class="ui button" id="playButton2">B</button>

        <p id="playerTitle1">Player 1</p>
        <ul class="ui list" id="playerPlayedList1"></ul>

        <br>
        <p id="playerTitle2">Player 2</p>
        <ul class="ui list" id="playerPlayedList2">
        </ul>

        <br>
        <p id="playerTitle3">Player 3</p>
        <ul class="ui list" id="playerPlayedList3">
        </ul>

        <br>
        <p id="playerTitle4">Player 4</p>
        <ul class="ui list" id="playerPlayedList4">
      </p>
    </div>
    <script>
      // var availableCards, currentPlayer, gameEnd;
      // var playAgainst, cardsNotPlayedYet;
      function initGame(state) {
        // Draw cards
        return state;
      }

      function resolve(state, action) {
        return Object.assign({}, state, {
            players: playAgainst(state.players, action, state.currentPlayerId),
            currentPlayerId: nextPlayer(state.players, state.currentPlayerId),
            // availableCards: removeCard(state.availableCards, action.cardToPlay)
          }
        );
      }

      function nextPlayer(players, currentPlayerId) {
        // Next non dead player
        let totalPlayers = players.length;
        let nextPlayerIndex = currentPlayerId % totalPlayers;
        // console.log(players);

        // while (players[nextPlayerIndex].dead == true && nextPlayerIndex != currentPlayerId - 1) {
        while (nextPlayerIndex === currentPlayerId - 1) {
          nextPlayerIndex = (nextPlayerIndex + 1) % totalPlayers;
        }
        console.log(`Next Player ID: ${nextPlayerIndex}`);

        return players[nextPlayerIndex].id;
      }

      function playAgainst(players, action, currentPlayerId) {
        return players.map(function CB(player, index) {
          if (player.id !== action.cardToPlay.playAgainst && player.id !== currentPlayerId) {
            return player;
          } else if (player.id === currentPlayerId) {
            // Remove card.
            let arr = player.holdingCards;
            let idx = arr.indexOf(cardRank[action.cardToPlay]);
            arr.splice(idx, 1);
            let playedCardsArr = player.playedCards;
            playedCardsArr.push(action.cardToPlay);
            return Object.assign({}, player, {
              holdingCards: arr,
              playedCards: playedCardsArr
            });
          } else {
            return Object.assign({}, player, {
              dead: !player.dead
            });
          }
        });
      }

      function getAvailableCardSize(availableCards) {
        let totalCards = 0;
        for (var key in availableCards) {
          if (availableCards.hasOwnProperty(key)) {
            totalCards += availableCards[key];
          }
        }
        return totalCards;
      }

      function getRandomCard(availableCards) {
        // Get the number of total cards
        let totalCards = getAvailableCardSize(availableCards);

        console.log(`Total Cards: ${totalCards}`);
        if (totalCards == 0) {
          return;
        }

        let randomCardNumber = Math.floor(Math.random() * totalCards);

        let temp = 0, drawedCard;
        for (var key in availableCards) {
          if (availableCards.hasOwnProperty(key)) {
            temp += availableCards[key];
            if (temp > randomCardNumber) {
              drawedCard = key;
              break;
            }
          }
        }

        console.log(`Card drawed: ${drawedCard}`);
        availableCards[drawedCard]--;
        return cardRank[drawedCard];
      }

      const cardRank = {
        'Guard': 1,
        'Priest': 2,
        'Baron': 3,
        'Handmaid': 4,
        'Prince': 5,
        'King': 6,
        'Countess': 7,
        'Princess': 8,
      }

      const cardNames = [
        'Guard',
        'Priest',
        'Baron',
        'Handmaid',
        'Prince',
        'King',
        'Countess',
        'Princess',
      ];

      function drawCard(previousState, action) {
        let cardDrew = getRandomCard(previousState.availableCards);

        return Object.assign({}, previousState, {
          players: addHoldingCards(previousState.players, previousState.currentPlayerId, cardDrew)
        });
      }

      function addHoldingCards(players, playerId, card) {
        return players.map(function CB(player, index) {
        if (player.id !== playerId) {
            return player;
          } else {
            let arr = player.holdingCards;
            arr.push(card);
            return Object.assign({}, player, {
              holdingCards: arr
            })
          }
        });
      }

      function counter(state, action) {
        if (typeof state === 'undefined') {
          return {
            counter: 0,
            currentPlayerId: 1,
            players: [
              {
                id: 1,
                dead: false,
                holdingCards: [
                  1,
                  2
                ],
                playedCards: []
              },
              {
                id: 2,
                dead: false,
                holdingCards: [
                  1,
                ],
                playedCards: []
              },
              {
                id: 3,
                dead: false,
                holdingCards: [
                  1,
                ],
                playedCards: []
              },
              {
                id: 4,
                dead: false,
                holdingCards: [
                  2,
                ],
                playedCards: []
              }
            ],
            availableCards: {
              'Guard': 1,
              'Priest': 1,
              'Baron': 1,
              'Handmaid': 2,
              'Prince': 2,
              'King': 1,
              'Countess': 1,
              'Princess': 1,
            }
          };
        }

        switch (action.type) {
          case 'INCREMENT':
            if (action.number === undefined) {
              action.number = 1;
            }
            return Object.assign({}, state, {
              counter: state.counter + action.number
            });
          case 'DECREMENT':
            return Object.assign({}, state, {
              counter: state.counter - 1
            });
          case 'PLAY_CARD':
            // Remove holding cards

            // Resolve

            // Check if game ends

            return resolve(state, action);
          case 'DRAW_CARD':
            return drawCard(state, action);
          default:
            return state
        }
      }

      var store = Redux.createStore(Redux.combineReducers({counter}))
      var valueEl = document.getElementById('value')
      var valueE2 = document.getElementById('currentPlayerId')
      var valueE3 = document.getElementById('playButton1')
      var valueE4 = document.getElementById('playButton2')
      function render() {
        valueEl.innerHTML = store.getState().counter.counter.toString()
        valueE2.innerHTML = store.getState().counter.currentPlayerId.toString()
        valueE3.innerHTML = cardNames[store.getState().counter.players[store.getState().counter.currentPlayerId - 1].holdingCards[0].toString() - 1]
        if (store.getState().counter.players[store.getState().counter.currentPlayerId - 1].holdingCards.length > 1) {
          valueE4.innerHTML = cardNames[store.getState().counter.players[store.getState().counter.currentPlayerId - 1].holdingCards[1].toString() - 1]
        }

        $(`#playerPlayedList1`).empty();
        $(`#playerPlayedList2`).empty();
        $(`#playerPlayedList3`).empty();
        $(`#playerPlayedList4`).empty();
        for (var i = 0; i < store.getState().counter.players[0].playedCards.length; ++i) {
          $(`#playerPlayedList1`).append(`<li class="item">${cardNames[store.getState().counter.players[0].playedCards[i].cardId - 1]}</li>`);
        }
        for (var i = 0; i < store.getState().counter.players[1].playedCards.length; ++i) {
          $(`#playerPlayedList2`).append(`<li class="item">${cardNames[store.getState().counter.players[1].playedCards[i].cardId - 1]}</li>`);
        }
        for (var i = 0; i < store.getState().counter.players[2].playedCards.length; ++i) {
          $(`#playerPlayedList3`).append(`<li class="item">${cardNames[store.getState().counter.players[2].playedCards[i].cardId - 1]}</li>`);
        }
        for (var i = 0; i < store.getState().counter.players[3].playedCards.length; ++i) {
          $(`#playerPlayedList4`).append(`<li class="item">${cardNames[store.getState().counter.players[3].playedCards[i].cardId - 1]}</li>`);
        }
      }
      render()
      store.subscribe(render)
      document.getElementById('increment')
        .addEventListener('click', function () {
          store.dispatch({ type: 'INCREMENT' })
        })
      document.getElementById('decrement')
        .addEventListener('click', function () {
          store.dispatch({ type: 'DECREMENT' })
        })
      document.getElementById('incrementIfOdd')
        .addEventListener('click', function () {
          if (store.getState() % 2 !== 0) {
            store.dispatch({ type: 'INCREMENT' })
          }
        })
      document.getElementById('incrementAsync')
        .addEventListener('click', function () {
          setTimeout(function () {
            store.dispatch({ type: 'INCREMENT' })
          }, 1000)
        })
      document.getElementById('incrementby2')
        .addEventListener('click', function () {
          store.dispatch({ type: 'INCREMENT', number: 2 });
          // console.log(store.getState());
        })
      document.getElementById('playButton1')
        .addEventListener('click', function () {
          store.dispatch({ type: 'PLAY_CARD', cardToPlay: {cardId: store.getState().counter.players[store.getState().counter.currentPlayerId - 1].holdingCards[0], playAgainst: 2, guardGuess: -1} });
          store.dispatch({ type: 'DRAW_CARD', player: store.getState().counter.currentPlayerId});
          // console.log(store.getState());
        })
      document.getElementById('playButton2')
        .addEventListener('click', function () {
          store.dispatch({ type: 'PLAY_CARD', cardToPlay: {cardId: store.getState().counter.players[store.getState().counter.currentPlayerId - 1].holdingCards[1], playAgainst: 2, guardGuess: -1} });
          store.dispatch({ type: 'DRAW_CARD', player: store.getState().counter.currentPlayerId});
          // console.log(store.getState());
        })
    </script>
  </body>
</html>